#!/usr/bin/python
import sys
import re

q = 4591
qinv = 15631
q16 = 14
qR2inv = 935519
_2P15 = (1 << 15)

def print_prologue():
	print('#include \"Toom.h\"\n')


def print_barrett_16x2(reg1, reg2, reg3):
	print('  r%d = __SMLAWB(ir_qR2inv, r%d, ir_2P15);' % (reg2, reg1))
	print('  r%d = __SMLAWT(ir_qR2inv, r%d, ir_2P15);' % (reg3, reg1))
	print('  r%d = __SMULBT(ir_q, r%d);' % (reg2, reg2))
	print('  r%d = __SMULBT(ir_q, r%d);' % (reg3, reg3))
	print('  r%d = __PKHBT(r%d, r%d, 16);' % (reg2, reg2, reg3))
	print('  r%d = __SSUB16(r%d, r%d);' % (reg1, reg1, reg2))


def print_eval_input_coefs(arr_name):
	print('void eval_input_coefs_%s(uint32_t *arrOut, uint32_t *arrIn) {' % (arr_name))
	print('  uint32_t r0, r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12;')
	if arr_name == 'c':
		print('  int32_t ir_qR2inv, ir_q, ir_2P15;')
		print('  ir_q = 4591;')
		print('  ir_qR2inv = 935519;')
		print('  ir_2P15 = 32768;')
	for it in range(96):
		print('  r3 = *(arrIn + 288);')
		print('  r2 = *(arrIn + 96);')
		print('  r1 = *(arrIn + 192);')
		print('  r0 = *(arrIn++);')
		print('  r4 = r2 & 0xFFFF7FFF;')
		print('  r5 = r3 & 0xFFFF1FFF;')
		print('  r4 = r4 << 1;')
		print('  r5 = r5 << 3;')
		print('  r4 = __SADD16(r4, r5);')
		if arr_name == 'c':
			print_barrett_16x2(4, 5, 6)
		print('  r5 = r1 & 0xFFFF3FFF;')
		print('  r5 = r5 << 2;')
		print('  r5 = __SADD16(r0, r5);')
		print('  r6 = __SADD16(r5, r4);')
		print('  r5 = __SSUB16(r5, r4);')
		if arr_name == 'c':
			print_barrett_16x2(6, 4, 7)
			print_barrett_16x2(5, 4, 7)
		print('  r4 = r0 & 0xFFFF1FFF;')
		print('  r7 = r1 & 0xFFFF7FFF;')
		print('  r4 = r4 << 3;')
		print('  r7 = r7 << 1;')
		print('  r4 = __SADD16(r4, r7);')
		print('  r0 = __SADD16(r0, r1);')
		if arr_name == 'c':
			print_barrett_16x2(4, 1, 7)
		print('  r7 = r2 & 0xFFFF3FFF;')
		print('  r7 = r7 << 2;')
		print('  r7 = __SADD16(r7, r3);')
		print('  r2 = __SADD16(r2, r3);')
		print('  r4 = __SADD16(r4, r7);')
		if arr_name == 'c':
			print_barrett_16x2(4, 1, 3)
		print('  r1 = __SSUB16(r0, r2);')
		print('  r0 = __SADD16(r0, r2);')
		if arr_name == 'c':
			print_barrett_16x2(1, 2, 3)
			print_barrett_16x2(0, 2, 3)
		print('  *(arrOut + 384) = r4;')
		print('  *(arrOut + 288) = r5;')
		print('  *(arrOut + 192) = r6;')
		print('  *(arrOut + 96) = r1;')
		print('  *(arrOut++) = r0;')
	print('}\n')


def print_interpol_output_coefs():
	print('void interpol_output_coefs(int32_t *h0, int32_t *h1) {')
	print('  int32_t ir0, ir1, ir2, ir3, ir4, ir5, ir6, ir7, ir8, ir9, ir10, ir11;')
	for it in range(383):
		print('  ir6 = *(h0 + 1152);')
		print('  ir0 = *(h0++);')
		print('  ir1 = *h1;')
		print('  ir2 = *(h0 + 383);')
		print('  ir3 = *(h1 + 384);')
		print('  ir4 = *(h0 + 767);')
		print('  ir5 = *(h1 + 768);')
		print('  ir7 = 935519;')
		print('  ir8 = 4591;')
		print('  ir9 = __SMMULR(ir7, ir0);')
		print('  ir0 = __MLS(ir8, ir9, ir0);')
		print('  ir9 = __SMMULR(ir7, ir1);')
		print('  ir1 = __MLS(ir8, ir9, ir1);')
		print('  ir9 = __SMMULR(ir7, ir2);')
		print('  ir2 = __MLS(ir8, ir9, ir2);')
		print('  ir9 = __SMMULR(ir7, ir3);')
		print('  ir3 = __MLS(ir8, ir9, ir3);')
		print('  ir9 = __SMMULR(ir7, ir4);')
		print('  ir4 = __MLS(ir8, ir9, ir4);')
		print('  ir9 = __SMMULR(ir7, ir5);')
		print('  ir5 = __MLS(ir8, ir9, ir5);')
		print('  ir9 = __SMMULR(ir7, ir6);')
		print('  ir6 = __MLS(ir8, ir9, ir6);')
		print('  ir0 = __PKHBT(ir0, ir2, 16);')
		print('  ir3 = __PKHBT(ir3, ir4, 16);')
		print('  ir5 = __PKHBT(ir5, ir6, 16);')
		print('  ir2 = 0xFA05FFFE;')
		print('  ir4 = 0x05FBFB83;')
		print('  ir6 = 0xF70AF70B;')
		print('  ir7 = 0x02FD047C;')
		print('  ir8 = 0x05FA08F7;')
		print('  ir2 = __SMUAD(ir0, ir2);')
		print('  ir4 = __SMUAD(ir0, ir4);')
		print('  ir6 = __SMUAD(ir0, ir6);')
		print('  ir7 = __SMUAD(ir0, ir7);')
		print('  ir0 = __SMUAD(ir0, ir8);')
		print('  ir8 = 204;')
		print('  ir2 -= ir8 * ir1;')
		print('  ir8 = 255;')
		print('  ir6 += ir8 * ir1;')
		print('  ir8 = 51;')
		print('  ir0 -= ir8 * ir1;')
		print('  ir1 = 0x087803FC;')
		print('  ir8 = 0xFFFE08AB;')
		print('  ir9 = 0x053B05FB;')
		print('  ir10 = 0x0004053B;')
		print('  ir2 = __SMLAD(ir3, ir1, ir2);')
		print('  ir2 = __SMLAD(ir5, ir8, ir2);')
		print('  ir4 = __SMLAD(ir3, ir9, ir4);')
		print('  ir4 = __SMLAD(ir5, ir10, ir4);')
		print('  ir1 = 0x00FF06F9;')
		print('  ir8 = 0xF70B0000;')
		print('  ir9 = 0xFAC502FD;')
		print('  ir10 = 0xFFFBFAC5;')
		print('  ir6 = __SMLAD(ir3, ir1, ir6);')
		print('  ir6 = __SMLAD(ir5, ir8, ir6);')
		print('  ir7 = __SMLAD(ir3, ir9, ir7);')
		print('  ir7 = __SMLAD(ir5, ir10, ir7);')
		print('  ir1 = 0x0878FE02;')
		print('  ir8 = 0x08F7F755;')
		print('  ir0 = __SMLAD(ir3, ir1, ir0);')
		print('  ir0 = __SMLAD(ir5, ir8, ir0);')
		print('  *(h1++) = ir2;')
		print('  *(h0 + 383) = ir4;')
		print('  *(h1 + 383) = ir6;')
		print('  *(h0 + 767) = ir7;')
		print('  *(h1 + 767) = ir0;')
	print('}\n')


def print_copy_output_coefs():
	print('void copy_output_coefs(int32_t *h0, int32_t *h1) {')
	print('  int32_t ir0, ir1, ir2, ir3, ir4, ir5, ir6, ir7, ir8, ir9, ir10, ir11;')
	for it in range(192):
		print('  ir0 = *(h1++);')
		print('  ir1 = *h0;')
		print('  ir2 = *(h1 + 383);')
		print('  ir3 = *(h0 + 384);')
		print('  ir4 = *(h1 + 767);')
		print('  ir5 = *(h0 + 768);')
		if it < 191:
			print('  ir6 = *(h1++);')
			print('  ir7 = *(h0 + 1);')
			print('  ir8 = *(h1 + 383);')
			print('  ir9 = *(h0 + 385);')
			print('  ir10 = *(h1 + 767);')
			print('  ir11 = *(h0 + 769);')
		print('  ir0 += ir1;')
		print('  ir2 += ir3;')
		print('  ir4 += ir5;')
		if it < 191:
			print('  ir6 += ir7;')
			print('  ir8 += ir9;')
			print('  ir10 += ir11;')
		print('  *(h0++) = ir0;')
		print('  *(h0 + 383) = ir2;')
		print('  *(h0 + 767) = ir4;')
		if it < 191:
			print('  *(h0++) = ir6;')
			print('  *(h0 + 383) = ir8;')
			print('  *(h0 + 767) = ir10;')
	print('}\n')


def print_Toom():
	print('// specialized for 768x768')
	print('void Toom4_mult(int32_t *h, uint32_t *c, uint32_t *f) {')
	print('  int32_t h_tmp[1152];')
	print('  uint32_t c_eval[480], f_eval[480];')
	print('')
	print('  eval_input_coefs_c(c_eval, c);')
	print('  eval_input_coefs_f(f_eval, f);')
	print('  Karatsuba_mult(h, c, f);')
	print('  Karatsuba_mult(h_tmp, c_eval + 384, f_eval + 384);')
	print('  Karatsuba_mult(h + 384, c_eval, f_eval);')
	print('  Karatsuba_mult(h_tmp + 384, c_eval + 96,  f_eval + 96);')
	print('  Karatsuba_mult(h + 768, c_eval + 192,  f_eval + 192);')
	print('  Karatsuba_mult(h_tmp + 768, c_eval + 288,  f_eval + 288);')
	print('  Karatsuba_mult(h + 1152, c + 288, f + 288);')
	print('  interpol_output_coefs(h, h_tmp);')
	print('  copy_output_coefs(h + 192, h_tmp);')
	print('}\n')


print_prologue()
print_eval_input_coefs('c')
print_eval_input_coefs('f')
print_interpol_output_coefs()
print_copy_output_coefs()
print_Toom()
